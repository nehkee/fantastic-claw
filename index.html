<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The Fantastic Claw ‚Äî Deal Finder</title>
  
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root {
      --bg: #0f1724; 
      --card: #131c2c; 
      --accent: #ff7a18; 
      --accent-grad: linear-gradient(135deg, #ff7a18, #ff3d81);
      --muted: #94a3b8; 
      --glass: rgba(255, 255, 255, 0.04);
      --glass-hover: rgba(255, 255, 255, 0.08);
      --success: #18c78b; 
      --danger: #ff6b6b; 
      --maxw: 800px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    * { box-sizing: border-box; }
    html, body { min-height: 100vh; margin: 0; }
    body {
      background: linear-gradient(180deg, var(--bg) 0%, #071024 100%);
      color: #e6eef8;
      display: flex;
      justify-content: center;
      padding: 40px 20px;
      line-height: 1.5;
    }

    .wrap { width: 100%; max-width: var(--maxw); display: flex; flex-direction: column; gap: 24px; }
    
    header { display: flex; align-items: center; gap: 18px; margin-bottom: 8px; }
    .logo { width: 64px; height: 64px; border-radius: 14px; background: var(--accent-grad); display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 8px 24px rgba(255, 122, 24, 0.25); }
    h1 { margin: 0; font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }
    p.lead { margin: 4px 0 0 0; color: var(--muted); font-size: 14px; max-width: 500px; }

    .card { background: var(--card); border-radius: 16px; padding: 24px; box-shadow: 0 12px 40px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.03); }
    .card-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 16px; }
    .card-title { font-weight: 700; font-size: 16px; color: #fff; }
    
    .form-row { display: flex; gap: 10px; margin-bottom: 12px; }
    input.url { flex: 1; padding: 14px 16px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.08); background: rgba(0,0,0,0.2); color: #fff; outline: none; font-size: 14px; transition: all 0.2s; }
    input.url:focus { border-color: var(--accent); background: rgba(0,0,0,0.4); box-shadow: 0 0 0 3px rgba(255, 122, 24, 0.15); }
    
    button { transition: all 0.2s ease; font-family: inherit; font-size: 14px; }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }
    button.primary { background: var(--accent-grad); border: none; color: #fff; padding: 14px 20px; border-radius: 10px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(255, 61, 129, 0.2); }
    button.primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(255, 61, 129, 0.3); }
    button.ghost { background: var(--glass); border: 1px solid rgba(255,255,255,0.05); color: #e6eef8; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 500; }
    button.ghost:hover:not(:disabled) { background: var(--glass-hover); }

    .status-area { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .status-left { display: flex; align-items: center; gap: 10px; color: var(--muted); font-size: 13px; }
    .status-badge { font-size: 12px; padding: 4px 8px; border-radius: 20px; background: var(--glass); border: 1px solid rgba(255,255,255,0.05); }
    
    .spinner { width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
    .spinner.active { display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* NEW STYLES FOR THE FORMATTED AI OUTPUT */
    .output-formatted { background: #07101a; padding: 20px; border-radius: 10px; color: #a5d2ff; border: 1px solid rgba(255,255,255,0.04); font-size: 15px; line-height: 1.6; min-height: 100px; margin: 0 0 16px 0; overflow-x: auto; }
    .output-formatted p { margin-top: 0; margin-bottom: 12px; }
    .output-formatted p:last-child { margin-bottom: 0; }
    .output-formatted ul, .output-formatted ol { margin-top: 0; margin-bottom: 12px; padding-left: 20px; }
    .output-formatted strong { color: #ffffff; font-weight: 700; }
    .output-formatted a { color: var(--accent); text-decoration: none; font-weight: 700; border-bottom: 1px solid rgba(255, 122, 24, 0.3); transition: all 0.2s; }
    .output-formatted a:hover { color: #ff3d81; border-bottom-color: #ff3d81; }
    
    .actions { display: flex; gap: 10px; flex-wrap: wrap; }

    .history { margin-top: 10px; }
    .hist-item { background: var(--glass); border: 1px solid rgba(255,255,255,0.02); padding: 12px 16px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; gap: 12px; transition: background 0.2s; }
    .hist-item:hover { background: var(--glass-hover); }
    .hist-url { font-weight: 600; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 400px; color: #fff; margin-bottom: 4px; }
    .muted { color: var(--muted); font-size: 12px; }
    
    footer { text-align: center; margin-top: 24px; color: var(--muted); font-size: 13px; }

    @media (max-width: 600px) {
      .form-row { flex-direction: column; }
      .hist-item { flex-direction: column; align-items: flex-start; }
      .hist-url { max-width: 100%; }
      button.primary { width: 100%; }
      .actions button { flex: 1; text-align: center; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    
    <header>
      <div class="logo">ü¶Ä</div>
      <div>
        <h1>The Fantastic Claw</h1>
        <p class="lead">Analyze product listings, find flips, and uncover underpriced deals instantly.</p>
      </div>
    </header>

    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Deal Scanner</div>
          <div class="muted">Paste an Amazon or marketplace URL below</div>
        </div>
        <div class="status-badge" id="app-status">Connecting...</div>
      </div>

      <div class="form-row">
        <input id="url-input" class="url" placeholder="https://example.com/vintage-chair" autocomplete="off" />
        <button id="analyze-btn" class="primary">Analyze</button>
        <button id="demo-btn" class="ghost">Run Demo</button>
      </div>

      <div class="status-area">
        <div class="status-left">
          <div id="spinner" class="spinner"></div>
          <span id="status-text">Ready to scan.</span>
        </div>
      </div>

      <div class="card-header" style="margin-bottom: 12px;">
        <div class="card-title">Analysis Output</div>
        <div class="muted">Powered by LangChain</div>
      </div>
      
      <div id="output" class="output-formatted">Awaiting instructions...</div>

      <div class="actions">
        <button id="copy-btn" class="ghost">Copy Results</button>
        <button id="tweet-btn" class="ghost">Share on X</button>
        <button id="download-btn" class="ghost">Save JSON</button>
        <button id="clear-btn" class="ghost" style="margin-left: auto;">Clear</button>
      </div>
    </section>

    <section class="card history" id="history-section" style="display: none;">
      <div class="card-header">
        <div class="card-title">Recent Scans</div>
      </div>
      <div id="history-list"></div>
    </section>

    <footer>
      The Fantastic Claw ‚Ä¢ Built with FastAPI & LangChain
    </footer>
    
  </div>

  <script>
    const api = { health: '/health', trigger: '/trigger-claw' }

    const $status = document.getElementById('app-status')
    const $statusText = document.getElementById('status-text')
    const $spinner = document.getElementById('spinner')
    const $output = document.getElementById('output')
    const $url = document.getElementById('url-input')
    const $analyze = document.getElementById('analyze-btn')
    const $demo = document.getElementById('demo-btn')
    const $copy = document.getElementById('copy-btn')
    const $tweet = document.getElementById('tweet-btn')
    const $download = document.getElementById('download-btn')
    const $clear = document.getElementById('clear-btn')
    const $historyList = document.getElementById('history-list')
    const $historySection = document.getElementById('history-section')

    let busy = false

    async function checkHealth(){
      try {
        const res = await fetch(api.health)
        if(!res.ok) throw new Error('unhealthy')
        const body = await res.json()
        $status.innerHTML = `üü¢ ${body.status || 'Live'}`
        $status.style.color = 'var(--success)'
        $status.style.borderColor = 'rgba(24, 199, 139, 0.2)'
      } catch(e) {
        $status.innerHTML = 'üî¥ Offline'
        $status.style.color = 'var(--danger)'
        $status.style.borderColor = 'rgba(255, 107, 107, 0.2)'
      }
    }

    function setBusy(isBusy) { 
      busy = isBusy; 
      $analyze.disabled = isBusy; 
      $demo.disabled = isBusy; 
      
      if(isBusy) {
        $spinner.classList.add('active');
        $statusText.textContent = 'Agent is analyzing the listing...';
        $statusText.style.color = '#fff';
      } else {
        $spinner.classList.remove('active');
        $statusText.textContent = 'Scan complete.';
        $statusText.style.color = 'var(--muted)';
      }
    }

    // THE MAGIC FIX: We use marked.parse() to safely turn the AI's markdown into perfect HTML
    function renderOutput(text) {
      // Configure marked to open links in a new tab
      marked.use({
        renderer: {
          link({ href, title, text }) {
            return `<a target="_blank" href="${href}" title="${title || ''}">${text}</a>`;
          }
        }
      });
      $output.innerHTML = marked.parse(text);
    }

    function pushHistory(item) {
      const items = JSON.parse(localStorage.getItem('fc_history')||'[]')
      items.unshift(item)
      if(items.length > 5) items.pop()
      localStorage.setItem('fc_history', JSON.stringify(items))
      renderHistory()
    }

    function renderHistory() {
      const items = JSON.parse(localStorage.getItem('fc_history')||'[]')
      if (items.length === 0) {
        $historySection.style.display = 'none';
        return;
      }
      
      $historySection.style.display = 'block';
      $historyList.innerHTML = ''
      
      items.forEach((it, idx) => {
        const div = document.createElement('div')
        div.className = 'hist-item'
        
        const displayUrl = it.url.replace(/^https?:\/\//, '').split('?')[0];

        div.innerHTML = `
          <div style="flex: 1; min-width: 0;">
            <div class='hist-url' title="${it.url}">${displayUrl}</div>
            <div class='muted'>${new Date(it.at).toLocaleTimeString()}</div>
          </div>
          <div>
            <button class='ghost' style="padding: 6px 12px; font-size: 12px;" data-idx='${idx}'>Reload</button>
          </div>
        `
        $historyList.appendChild(div)
      })

      $historyList.querySelectorAll('button').forEach(btn => btn.addEventListener('click', (e) => {
        const idx = e.currentTarget.dataset.idx
        const items = JSON.parse(localStorage.getItem('fc_history')||'[]')
        const it = items[idx]
        if(it) { 
          $url.value = it.url; 
          renderOutput(it.result);
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      }))
    }

    async function analyze(url){
      if(!url) return alert('Please enter a URL first.')
      setBusy(true)
      
      // Temporarily write plain text while loading
      $output.innerHTML = '<p>Scraping page and generating AI analysis...</br>This usually takes 5-15 seconds.</p>'
      
      try {
        const res = await fetch(api.trigger + '?url=' + encodeURIComponent(url), {method:'POST'})
        if(!res.ok) { const t=await res.text(); throw new Error(t||'Request failed') }
        
        const data = await res.json()
        const result = (data.result || data.output || JSON.stringify(data, null, 2))
        
        // Render the final markdown result
        renderOutput(result)
        pushHistory({url, result, at: Date.now()})
      } catch(err) {
        console.error(err)
        $output.innerHTML = `<p style="color: var(--danger);">‚ö†Ô∏è Error: ${err.message || err}</p>`
      } finally { 
        setBusy(false) 
      }
    }

    $analyze.addEventListener('click', () => analyze($url.value.trim()))
    
    $url.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') analyze($url.value.trim())
    })

    $demo.addEventListener('click', () => {
      const demoUrl = 'https://marketplace.com/laptop-dell-xps-13'
      $url.value = demoUrl
      analyze(demoUrl)
    })

    $copy.addEventListener('click', () => {
      // Copy plain text, not HTML
      navigator.clipboard.writeText($output.innerText).then(() => {
        const originalText = $copy.textContent;
        $copy.textContent = '‚úì Copied!';
        setTimeout(() => $copy.textContent = originalText, 2000);
      })
    })

    $tweet.addEventListener('click', () => {
      const text = encodeURIComponent($output.innerText.substring(0,240) + '...\n\nAnalyzed by The Fantastic Claw ü¶Ä')
      window.open(`https://x.com/intent/tweet?text=${text}`, '_blank')
    })

    $download.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify({
        url: $url.value,
        result: $output.innerText,
        timestamp: new Date().toISOString()
      }, null, 2)], {type:'application/json'})
      
      const a = document.createElement('a')
      a.href = URL.createObjectURL(blob)
      a.download = `fantastic-claw-${Date.now()}.json`
      document.body.appendChild(a); a.click(); a.remove()
    })

    $clear.addEventListener('click', () => { 
      $output.innerHTML = 'Awaiting instructions...';
      $url.value = '';
    })

    checkHealth(); 
    renderHistory();
  </script>
</body>
</html>